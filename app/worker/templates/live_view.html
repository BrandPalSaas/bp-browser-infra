<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Worker Live View</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        .status-panel {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .connection-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        .connected {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .disconnected {
            background-color: #f2dede;
            color: #a94442;
        }
        .has-control {
            background-color: #d9edf7;
            color: #31708f;
        }
        .no-control {
            background-color: #fcf8e3;
            color: #8a6d3b;
        }
        .browser-view {
            position: relative;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .browser-screen {
            display: block;
            width: 100%;
            height: auto;
            max-height: 70vh;
            object-fit: contain;
        }
        .control-panel {
            display: flex;
            padding: 10px;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .url-bar {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }
        .go-button {
            padding: 8px 15px;
            background-color: #0078d7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .go-button:hover {
            background-color: #006cc1;
        }
        .control-btn {
            padding: 8px 15px;
            background-color: #5cb85c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .control-btn:hover {
            background-color: #4cae4c;
        }
        .status {
            font-size: 14px;
            margin-top: 10px;
            color: #666;
        }
        .view-only-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        .view-only-message {
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
        }
        .task-panel {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .task-header {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .task-content {
            margin-bottom: 10px;
            word-break: break-all;
        }
        .active-task {
            background-color: #d9edf7;
            border-color: #bce8f1;
        }
        .completed-task {
            background-color: #dff0d8;
            border-color: #d6e9c6;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f8f8f8;
            border: 1px solid #e9e9e9;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Browser Worker Live View <span id="worker-name"></span></h2>
            <div class="status-panel">
                <span class="connection-status disconnected" id="connection-status">Disconnected</span>
                <span class="connection-status no-control" id="control-status">No Control</span>
                <button id="request-control-btn" class="control-btn">Request Control</button>
            </div>
        </div>
        
        <!-- Task Information Panel -->
        <div id="task-panel" class="task-panel" style="display: none;">
            <div class="task-header">Current Task</div>
            <div id="task-id" class="task-content">No active task</div>
            <div class="task-header">Task Result</div>
            <pre id="task-result" class="task-content">No result available</pre>
        </div>
        
        <div class="browser-view">
            <img id="browserScreen" class="browser-screen" src="" alt="Browser Screen">
            <div id="view-only-overlay" class="view-only-overlay">
                <div class="view-only-message">VIEW ONLY MODE</div>
            </div>
        </div>
        <div id="control-elements">
            <div class="control-panel">
                <div class="status" id="status">Ready...</div>
            </div>
        </div>
    </div>

    <script>
        const workerName = "{{worker_name}}";
        document.getElementById('worker-name').textContent = workerName;
        
        let socket = null;
        let hasControl = false;
        
        // Setup WebSocket connection
        function connectWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/live/${workerName}`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function(e) {
                updateConnectionStatus(true);
                updateStatus("Connected to live view");
            };
            
            socket.onmessage = function(event) {
                // Handle binary data (screenshots)
                if (event.data instanceof Blob) {
                    const url = URL.createObjectURL(event.data);
                    document.getElementById('browserScreen').src = url;
                    return;
                }
                
                // Handle JSON messages
                try {
                    const message = JSON.parse(event.data);
                    
                    // Handle control status updates
                    if (message.type === 'control_status') {
                        hasControl = message.has_control;
                        updateControlStatus(hasControl);
                    }
                    // Handle task updates
                    else if (message.type === 'task_update') {
                        updateTaskInfo(message.task_id, message.task_result);
                    }
                } catch (error) {
                    console.error("Error parsing WebSocket message:", error);
                }
            };
            
            socket.onclose = function(event) {
                updateConnectionStatus(false);
                updateStatus("Disconnected from live view");
                
                // Try to reconnect after a delay
                setTimeout(connectWebSocket, 3000);
            };
            
            socket.onerror = function(error) {
                console.error("WebSocket error:", error);
                updateStatus("WebSocket error: " + error.message);
            };
        }
        
        // Update the task information display
        function updateTaskInfo(taskId, taskResult) {
            const taskPanel = document.getElementById('task-panel');
            const taskIdElement = document.getElementById('task-id');
            const taskResultElement = document.getElementById('task-result');
            
            // Show the task panel
            taskPanel.style.display = 'block';
            
            // Update task ID
            if (taskId) {
                taskIdElement.textContent = `Task ID: ${taskId}`;
                taskPanel.classList.add('active-task');
                taskPanel.classList.remove('completed-task');
            } else {
                taskIdElement.textContent = 'No active task';
                taskPanel.classList.remove('active-task');
            }
            
            // Update task result
            if (taskResult) {
                taskResultElement.textContent = typeof taskResult === 'object' 
                    ? JSON.stringify(taskResult, null, 2)
                    : taskResult;
                taskPanel.classList.add('completed-task');
                taskPanel.classList.remove('active-task');
            } else {
                taskResultElement.textContent = 'No result available';
            }
        }
        
        // Update the connection status display
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected) {
                statusElement.textContent = "Connected";
                statusElement.classList.remove('disconnected');
                statusElement.classList.add('connected');
            } else {
                statusElement.textContent = "Disconnected";
                statusElement.classList.remove('connected');
                statusElement.classList.add('disconnected');
            }
        }
        
        // Update the control status display
        function updateControlStatus(hasControl) {
            const controlStatusElement = document.getElementById('control-status');
            const viewOnlyOverlay = document.getElementById('view-only-overlay');
            
            if (hasControl) {
                controlStatusElement.textContent = "Has Control";
                controlStatusElement.classList.remove('no-control');
                controlStatusElement.classList.add('has-control');
                viewOnlyOverlay.style.display = 'none';
            } else {
                controlStatusElement.textContent = "No Control";
                controlStatusElement.classList.remove('has-control');
                controlStatusElement.classList.add('no-control');
                viewOnlyOverlay.style.display = 'flex';
            }
        }
        
        // Update the status message
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // Request control from the server
        function requestControl() {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            
            const controlRequest = {
                type: 'request_control'
            };
            
            socket.send(JSON.stringify(controlRequest));
            updateStatus("Requesting control...");
        }
        
        // Set up event listeners
        document.getElementById('request-control-btn').addEventListener('click', requestControl);
        
        // Browser screen interaction
        const browserScreen = document.getElementById('browserScreen');
        browserScreen.addEventListener('click', function(e) {
            if (!socket || socket.readyState !== WebSocket.OPEN || !hasControl) return;
            
            const rect = browserScreen.getBoundingClientRect();
            const scaleX = browserScreen.naturalWidth / browserScreen.clientWidth;
            const scaleY = browserScreen.naturalHeight / browserScreen.clientHeight;
            
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            const clickCommand = {
                type: 'click',
                x: Math.round(x),
                y: Math.round(y),
                id: Date.now()  // Add an ID to track command responses
            };
            
            socket.send(JSON.stringify(clickCommand));
            updateStatus(`Click at ${Math.round(x)}, ${Math.round(y)}`);
        });

        // Keyboard input handling
        document.addEventListener('keydown', function(e) {
            // Only handle keyboard input when the browser has control and user is not in an input element
            if (!socket || socket.readyState !== WebSocket.OPEN || !hasControl || 
                (document.activeElement && document.activeElement.tagName === 'INPUT')) return;
            
            // Map special keys
            const specialKeys = {
                'Enter': 'Enter',
                'Tab': 'Tab',
                'Escape': 'Escape',
                'Backspace': 'Backspace',
                'Delete': 'Delete',
                'ArrowUp': 'ArrowUp',
                'ArrowDown': 'ArrowDown',
                'ArrowLeft': 'ArrowLeft',
                'ArrowRight': 'ArrowRight',
                'Home': 'Home',
                'End': 'End',
                'PageUp': 'PageUp',
                'PageDown': 'PageDown',
                'F1': 'F1',
                'F2': 'F2',
                'F3': 'F3',
                'F4': 'F4',
                'F5': 'F5',
                'F6': 'F6',
                'F7': 'F7',
                'F8': 'F8',
                'F9': 'F9',
                'F10': 'F10',
                'F11': 'F11',
                'F12': 'F12'
            };
            
            // Handle normal keys vs special keys
            if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
                // Normal character key
                const typeCommand = {
                    type: 'type',
                    text: e.key,
                    id: Date.now()
                };
                socket.send(JSON.stringify(typeCommand));
            } else if (specialKeys[e.key]) {
                // Special key
                const keyCommand = {
                    type: 'key',
                    key: specialKeys[e.key],
                    id: Date.now()
                };
                socket.send(JSON.stringify(keyCommand));
                e.preventDefault();  // Prevent default browser behavior for special keys
            } else if (e.ctrlKey && e.key.length === 1) {
                // Ctrl+key combinations
                const keyCommand = {
                    type: 'key',
                    key: `Control+${e.key.toUpperCase()}`,
                    id: Date.now()
                };
                socket.send(JSON.stringify(keyCommand));
                e.preventDefault();
            }
        });
        
        // Connect when the page loads
        connectWebSocket();
    </script>
</body>
</html> 